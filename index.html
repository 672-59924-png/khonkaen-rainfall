<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khon Kaen Rainfall</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --bg:#f4f6f8; --card:#fff; --text:#000;
}
.dark{
  --bg:#111; --card:#1e1e1e; --text:#fff;
}
body{
  font-family:system-ui,sans-serif;
  background:var(--bg); color:var(--text);
  margin:0; padding:20px;
}
.top{
  display:flex; justify-content:space-between;
  flex-wrap:wrap; gap:10px;
}
select,button{padding:6px}
.card{
  background:var(--card);
  padding:16px; border-radius:10px;
  margin-top:20px;
}
.stats{
  display:grid; grid-template-columns:repeat(auto-fit,minmax(160px,1fr));
  gap:10px;
}
.stat{
  background:rgba(0,0,0,.05);
  padding:10px; border-radius:8px;
  text-align:center;
}
table{width:100%; border-collapse:collapse}
th,td{padding:6px; border-bottom:1px solid #ccc; text-align:center}
</style>
</head>

<body>
<div class="top">
  <h1 id="title"></h1>
  <div>
    <select id="lang"></select>
    <select id="range"></select>
    <select id="mode">
      <option value="daily">Daily</option>
      <option value="monthly">Monthly</option>
    </select>
    <button onclick="toggleDark()">ðŸŒ™</button>
    <button onclick="exportCSV()">â¬‡ CSV</button>
  </div>
</div>

<p id="subtitle"></p>

<div class="stats">
  <div class="stat"><div id="s_total">-</div><small id="l_total"></small></div>
  <div class="stat"><div id="s_avg">-</div><small id="l_avg"></small></div>
  <div class="stat"><div id="s_max">-</div><small id="l_max"></small></div>
</div>

<div class="card"><canvas id="chart"></canvas></div>

<div class="card">
  <h3 id="tableTitle"></h3>
  <table>
    <thead><tr><th id="th_date"></th><th id="th_rain"></th></tr></thead>
    <tbody id="table"></tbody>
  </table>
</div>

<script>
/* ---------- à¸ à¸²à¸©à¸² ---------- */
const T={
th:{title:"à¸›à¸£à¸´à¸¡à¸²à¸“à¸™à¹‰à¸³à¸à¸™ à¸ˆà¸±à¸‡à¸«à¸§à¸±à¸”à¸‚à¸­à¸™à¹à¸à¹ˆà¸™",
sub:"à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸›à¸£à¸´à¸¡à¸²à¸“à¸™à¹‰à¸³à¸à¸™à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡ (à¸­à¸´à¸‡à¹à¸™à¸§à¸„à¸´à¸”à¸ˆà¸²à¸à¸ªà¸–à¸²à¸™à¸µà¸­à¸¸à¸•à¸¸à¸™à¸´à¸¢à¸¡à¸§à¸´à¸—à¸¢à¸²à¸‚à¸­à¸™à¹à¸à¹ˆà¸™)",
total:"à¸à¸™à¸£à¸§à¸¡",avg:"à¹€à¸‰à¸¥à¸µà¹ˆà¸¢/à¸§à¸±à¸™",max:"à¸¡à¸²à¸à¸ªà¸¸à¸”",
date:"à¸§à¸±à¸™à¸—à¸µà¹ˆ",rain:"à¸¡à¸¡.",table:"à¸•à¸²à¸£à¸²à¸‡à¸‚à¹‰à¸­à¸¡à¸¹à¸¥"},
en:{title:"Rainfall in Khon Kaen",
sub:"Historical rainfall data (based on Khon Kaen Meteorological Station)",
total:"Total",avg:"Average/day",max:"Max",
date:"Date",rain:"mm",table:"Data table"},
ja:{title:"ã‚³ãƒ³ã‚±ãƒ³çœŒã®é™æ°´é‡",
sub:"ã‚³ãƒ³ã‚±ãƒ³æ°—è±¡è¦³æ¸¬æ‰€ã«åŸºã¥ãé™æ°´é‡ãƒ‡ãƒ¼ã‚¿",
total:"åˆè¨ˆ",avg:"å¹³å‡",max:"æœ€å¤§",
date:"æ—¥ä»˜",rain:"mm",table:"ãƒ‡ãƒ¼ã‚¿è¡¨"},
zh:{title:"å­”æ•¬åºœé™é›¨é‡",
sub:"åŸºäºŽå­”æ•¬æ°”è±¡ç«™çš„æ•°æ®",
total:"æ€»é‡",avg:"å¹³å‡",max:"æœ€å¤§",
date:"æ—¥æœŸ",rain:"æ¯«ç±³",table:"æ•°æ®è¡¨"}
};

/* ---------- UI setup ---------- */
const langSel=lang;
["th","en","ja","zh"].forEach(l=>{
  langSel.innerHTML+=`<option value="${l}">${l.toUpperCase()}</option>`;
});
[7,30,90,120,150,365,500,730].forEach(d=>{
  range.innerHTML+=`<option value="${d}">${d} days</option>`;
});

/* ---------- data (à¸ˆà¸³à¸¥à¸­à¸‡ 2 à¸›à¸µ) ---------- */
const ALL=[];
const today=new Date();
for(let i=730;i>=0;i--){
  const d=new Date(today);
  d.setDate(d.getDate()-i);
  ALL.push({
    date:d.toISOString().slice(0,10),
    rain:+(Math.random()*40).toFixed(1)
  });
}

let chart;

/* ---------- render ---------- */
function render(){
  const l=langSel.value;
  const days=+range.value;
  const mode=document.getElementById("mode").value;
  const t=T[l];

  title.innerText=t.title;
  subtitle.innerText=t.sub;
  l_total.innerText=t.total;
  l_avg.innerText=t.avg;
  l_max.innerText=t.max;
  th_date.innerText=t.date;
  th_rain.innerText=t.rain;
  tableTitle.innerText=t.table;

  let data=ALL.slice(-days);

  if(mode==="monthly"){
    const m={};
    data.forEach(d=>{
      const k=d.date.slice(0,7);
      m[k]=(m[k]||0)+d.rain;
    });
    data=Object.entries(m).map(([k,v])=>({date:k,rain:+v.toFixed(1)}));
  }

  // stats
  const total=data.reduce((a,b)=>a+b.rain,0);
  s_total.innerText=total.toFixed(1);
  s_avg.innerText=(total/data.length).toFixed(1);
  s_max.innerText=Math.max(...data.map(d=>d.rain)).toFixed(1);

  // chart
  if(chart) chart.destroy();
  chart=new Chart(chartEl,{
    type:"bar",
    data:{labels:data.map(d=>d.date),
      datasets:[{label:t.rain,data:data.map(d=>d.rain)}]},
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });

  // table
  table.innerHTML="";
  data.forEach(d=>{
    table.innerHTML+=`<tr><td>${d.date}</td><td>${d.rain}</td></tr>`;
  });

  save();
}

/* ---------- extra ---------- */
function exportCSV(){
  let csv="date,rain\n";
  document.querySelectorAll("#table tr").forEach(r=>{
    csv+=r.innerText.replace("\t",",")+"\n";
  });
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv]));
  a.download="rainfall.csv";
  a.click();
}
function toggleDark(){
  document.body.classList.toggle("dark");
  localStorage.dark=document.body.classList.contains("dark");
}
function save(){
  localStorage.lang=langSel.value;
  localStorage.range=range.value;
  localStorage.mode=mode.value;
}
function load(){
  if(localStorage.dark==="true") document.body.classList.add("dark");
  langSel.value=localStorage.lang||"th";
  range.value=localStorage.range||"30";
  mode.value=localStorage.mode||"daily";
}
load(); render();
</script>
</body>
</html>
