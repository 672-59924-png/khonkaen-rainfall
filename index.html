<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Khon Kaen Rainfall</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body {
  font-family: system-ui, sans-serif;
  background: #f4f6f8;
  padding: 20px;
}
.top {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 10px;
}
.card {
  background: #fff;
  padding: 16px;
  border-radius: 10px;
  margin-top: 20px;
}
select, button {
  padding: 6px;
  margin-right: 5px;
}
table {
  width: 100%;
  border-collapse: collapse;
}
th, td {
  border-bottom: 1px solid #eee;
  padding: 6px;
  text-align: center;
}
th {
  background: #f0f0f0;
}
</style>
</head>

<body>

<div class="top">
  <h1 id="title">Rainfall in Khon Kaen</h1>

  <div>
    <select onchange="setLang(this.value)">
      <option value="en">English</option>
      <option value="th">ไทย</option>
      <option value="ja">日本語</option>
      <option value="zh">中文</option>
    </select>

    <select onchange="setRange(this.value)">
      <option value="7">7 days</option>
      <option value="30" selected>30 days</option>
      <option value="90">90 days</option>
    </select>

    <select onchange="setMode(this.value)">
      <option value="daily">Daily</option>
      <option value="monthly">Monthly</option>
      <option value="yearly">Yearly</option>
    </select>
  </div>
</div>

<p id="subtitle">Rainfall data (last 2 years)</p>

<div class="card">
  <canvas id="rainChart"></canvas>
</div>

<div class="card">
  <h3 id="tableTitle">Rainfall Table</h3>
  <table>
    <thead>
      <tr>
        <th id="thDate">Date</th>
        <th id="thRain">Rainfall (mm)</th>
      </tr>
    </thead>
    <tbody id="rainTable"></tbody>
  </table>
</div>

<script>
/* ===== ภาษา ===== */
const T = {
  en:{title:"Rainfall in Khon Kaen",sub:"Rainfall data (last 2 years)",table:"Rainfall Table",date:"Date",rain:"Rainfall (mm)"},
  th:{title:"ปริมาณน้ำฝน จังหวัดขอนแก่น",sub:"ข้อมูลปริมาณน้ำฝนย้อนหลัง 2 ปี",table:"ตารางข้อมูลน้ำฝน",date:"วันที่",rain:"ปริมาณน้ำฝน (มม.)"},
  ja:{title:"コンケン県の降水量",sub:"過去2年間の降水量データ",table:"降水量データ表",date:"日付",rain:"降水量 (mm)"},
  zh:{title:"孔敬府降雨量",sub:"过去两年的降雨数据",table:"降雨数据表",date:"日期",rain:"降雨量 (毫米)"}
};

function setLang(l){
  document.getElementById("title").innerText=T[l].title;
  document.getElementById("subtitle").innerText=T[l].sub;
  document.getElementById("tableTitle").innerText=T[l].table;
  document.getElementById("thDate").innerText=T[l].date;
  document.getElementById("thRain").innerText=T[l].rain;
}

/* ===== ตัวแปรควบคุม ===== */
let rawData=[], range=30, mode="daily", chart;

/* ===== โหลด CSV ===== */
fetch("khonkaen_rainfall.csv")
.then(r=>r.text())
.then(t=>{
  const rows=t.trim().split("\n").slice(1);
  rawData=rows.map(r=>{
    const [d,v]=r.split(",");
    return {date:new Date(d),rain:+v};
  });
  update();
});

function setRange(v){range=+v;update();}
function setMode(v){mode=v;update();}

/* ===== ประมวลผล ===== */
function update(){
  let data=[...rawData].slice(-range);

  if(mode!=="daily"){
    const g={};
    data.forEach(d=>{
      const k=mode==="monthly"
        ?`${d.date.getFullYear()}-${d.date.getMonth()+1}`
        :d.date.getFullYear();
      g[k]=(g[k]||0)+d.rain;
    });
    data=Object.entries(g).map(([k,v])=>({label:k,rain:v}));
  }

  drawChart(data);
  fillTable(data);
}

/* ===== กราฟ ===== */
function drawChart(data){
  if(chart) chart.destroy();
  chart=new Chart(rainChart,{
    type:"bar",
    data:{
      labels:data.map(d=>d.label||d.date.toISOString().slice(0,10)),
      datasets:[{label:"mm",data:data.map(d=>d.rain)}]
    },
    options:{responsive:true,scales:{y:{beginAtZero:true}}}
  });
}

/* ===== ตาราง ===== */
function fillTable(data){
  rainTable.innerHTML="";
  data.forEach(d=>{
    rainTable.innerHTML+=
      `<tr><td>${d.label||d.date.toISOString().slice(0,10)}</td><td>${d.rain.toFixed(1)}</td></tr>`;
  });
}
</script>

</body>
</html>

